using System.Net;
using AutoMapper;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.SignalR;
using TH.Common.Lang;
using TH.Common.Model;
using $namespace$.App;
using $namespace$.Core;

namespace $namespace$.API;

[Authorize(Policy = "ClaimBasedPolicy")]
public class $WE$Controller : CustomBaseController
{
    private readonly I$WE$Service _$we$Service;
    private readonly IMapper _mapper;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IHubContext<$WE$Hub, I$WE$Hub> _hubContext;

    public $WE$Controller(I$WE$Service $we$Service, IMapper mapper, IServiceScopeFactory scopeFactory, HttpContextAccessor httpContextAccessor, IHubContext<$WE$Hub, I$WE$Hub> hubContext) : base(httpContextAccessor)
    {
        _$we$Service = $we$Service ?? throw new ArgumentNullException(nameof($we$Service));
        _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        _scopeFactory = scopeFactory ?? throw new ArgumentNullException(nameof(scopeFactory));
        _hubContext = hubContext ?? throw new ArgumentNullException(nameof(hubContext));

        _$we$Service.SetUserResolver(UserResolver);
    }

    [HttpPost("Save$WE$Async")]
    [ProducesResponseType(typeof($WE$ViewModel), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$WritePolicy")]
    public async Task<IActionResult> Save$WE$Async([FromBody] $WE$InputModel model)
    {
        var entity = await _$we$Service.SaveAsync(_mapper.Map<$WE$InputModel, $WE$>(model), DataFilter);
        if (entity is null) return CustomResult(Lang.Find("error_not_found"), entity, HttpStatusCode.NotFound);

        using (var scope = _scopeFactory.CreateScope())
        {
            var filter = new $WE$FilterModel { Id = entity.Id };
            var service = scope.ServiceProvider.GetRequiredService<I$WE$Service>();
            var viewModel = _mapper.Map<$WE$, $WE$ViewModel>(await service.FindByIdAsync(filter, DataFilter));

            await _hubContext.Clients.All.BroadcastOnSave$WE$Async(viewModel);

            return CustomResult(Lang.Find("success"));
        }
    }

    [HttpPost("Update$WE$Async")]
    [ProducesResponseType(typeof($WE$ViewModel), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$UpdatePolicy")]
    public async Task<IActionResult> Update$WE$Async([FromBody] $WE$InputModel model)
    {
        var entity = await _$we$Service.UpdateAsync(_mapper.Map<$WE$InputModel, $WE$>(model), DataFilter);
        if (entity is null) return CustomResult(Lang.Find("error_not_found"), entity, HttpStatusCode.NotFound);

        using (var scope = _scopeFactory.CreateScope())
        {
            var filter = new $WE$FilterModel { Id = entity.Id };
            var service = scope.ServiceProvider.GetRequiredService<I$WE$Service>();
            var viewModel = _mapper.Map<$WE$, $WE$ViewModel>(await service.FindByIdAsync(filter, DataFilter));

            await _hubContext.Clients.All.BroadcastOnUpdate$WE$Async(viewModel);

            return CustomResult(Lang.Find("success"));
        }
    }

    [HttpPost("Archive$WE$Async")]
    [ProducesResponseType(typeof(bool), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$ArchivePolicy")]
    public async Task<IActionResult> Archive$WE$Async([FromBody] $WE$InputModel model)
    {
        //first grab it
        var filter = new $WE$FilterModel { Id = model.Id };
        var viewModel = _mapper.Map<$WE$, $WE$ViewModel>(await _$we$Service.FindByIdAsync(filter, DataFilter));

        //then archive
        await _$we$Service.ArchiveAsync(_mapper.Map<$WE$InputModel, $WE$>(model), DataFilter);

        await _hubContext.Clients.All.BroadcastOnArchive$WE$Async(viewModel);

        return CustomResult(Lang.Find("success"));
    }

    [HttpPost("Delete$WE$Async")]
    [ProducesResponseType(typeof(bool), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$DeletePolicy")]
    public async Task<IActionResult> Delete$WE$Async([FromBody] $WE$InputModel model)
    {
        //first grab it
        var filter = new $WE$FilterModel { Id = model.Id };
        var viewModel = _mapper.Map<$WE$, $WE$ViewModel>(await _$we$Service.FindByIdAsync(filter, DataFilter));

        //then delete
        await _$we$Service.DeleteAsync(_mapper.Map<$WE$InputModel, $WE$>(model), DataFilter);

        await _hubContext.Clients.All.BroadcastOnDelete$WE$Async(viewModel);

        return CustomResult(Lang.Find("success"));
    }

    [HttpPost("Find$WE$Async")]
    [ProducesResponseType(typeof($WE$ViewModel), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$ReadPolicy")]
    public async Task<IActionResult> Find$WE$Async([FromBody] $WE$FilterModel filter)
    {
        var entity = await _$we$Service.FindByIdAsync(filter, DataFilter);
        if (entity is null) return CustomResult(Lang.Find("error_not_found"), entity, HttpStatusCode.NotFound);

        return CustomResult(Lang.Find("success"), _mapper.Map<$WE$, $WE$ViewModel>(entity));
    }

    [HttpPost("Get$WES$Async")]
    [ProducesResponseType(typeof(List<$WE$ViewModel>), (int)HttpStatusCode.OK)]
    [Authorize(Policy = "$WE$ReadPolicy")]
    public async Task<IActionResult> Get$WES$Async([FromBody] $WE$FilterModel filter)
    {
        var entities = await _$we$Service.GetAsync(filter, DataFilter);
        if (entities is null) return CustomResult(Lang.Find("error_not_found"), entities, HttpStatusCode.NotFound);

        return CustomResult(Lang.Find("success"), _mapper.Map<List<$WE$>, List<$WE$ViewModel>>(entities.ToList()));
    }

    public override void Dispose()
    {
        _$we$Service?.Dispose();
    }
}